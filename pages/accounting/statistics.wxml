<!--pages/accounting/statistics.wxml-->
<view class="container">
  <!-- æ—¶é—´ç­›é€‰å™¨ -->
  <view class="filter-section">
    <view class="filter-buttons">
      <view 
        class="filter-btn {{timeRange === 'day' ? 'active' : ''}}" 
        data-range="day"
        bindtap="onTimeRangeChange"
      >
        ä»Šæ—¥
      </view>
      <view 
        class="filter-btn {{timeRange === 'week' ? 'active' : ''}}" 
        data-range="week"
        bindtap="onTimeRangeChange"
      >
        æœ¬å‘¨
      </view>
      <view 
        class="filter-btn {{timeRange === 'month' ? 'active' : ''}}" 
        data-range="month"
        bindtap="onTimeRangeChange"
      >
        æœ¬æœˆ
      </view>
      <view 
        class="filter-btn {{timeRange === 'year' ? 'active' : ''}}" 
        data-range="year"
        bindtap="onTimeRangeChange"
      >
        ä»Šå¹´
      </view>
    </view>
    
    <picker 
      class="date-picker" 
      mode="date" 
      fields="month"
      value="{{customDate}}"
      bindchange="onCustomDateChange"
    >
      <text class="date-text">è‡ªå®šä¹‰</text>
    </picker>
  </view>

  <!-- å…³é”®æŒ‡æ ‡ -->
  <view class="metrics-section">
    <view class="metric-card income-card">
      <text class="metric-label">æ€»æ”¶å…¥</text>
      <text class="metric-value">Â¥{{formattedTotalIncome}}</text>
      <text class="metric-change">è¾ƒä¸Šæœˆ {{incomeChange || 0}}%</text>
    </view>
    
    <view class="metric-card expense-card">
      <text class="metric-label">æ€»æ”¯å‡º</text>
      <text class="metric-value">Â¥{{formattedTotalExpense}}</text>
      <text class="metric-change">è¾ƒä¸Šæœˆ {{expenseChange || 0}}%</text>
    </view>
    
    <view class="metric-card balance-card">
      <text class="metric-label">ç»“ä½™</text>
      <text class="metric-value {{balanceClass}}">
        Â¥{{formattedBalance}}
      </text>
      <text class="metric-change">é¢„ç®—å‰©ä½™ {{budgetRemaining || 0}}%</text>
    </view>
  </view>

  <!-- æ”¯å‡ºåˆ†ç±»é¥¼å›¾ -->
  <view class="chart-section">
    <view class="section-header">
      <text class="section-title">æ”¯å‡ºåˆ†ç±»å æ¯”</text>
      <button class="export-btn" bindtap="onExportData">å¯¼å‡ºæ•°æ®</button>
    </view>
    
    <view class="chart-container">
      <canvas class="pie-chart" type="2d" id="pieChart" style="width: 100%; height: 100%;"></canvas>
    </view>
    
    <view class="legend-container">
      <view 
        class="legend-item" 
        wx:for="{{chartData.pieChart}}" 
        wx:key="name"
      >
        <view class="legend-color" style="background-color: {{item.color}}"></view>
        <text class="legend-name">{{item.name}}</text>
        <text class="legend-percent">{{item.percentage}}%</text>
        <text class="legend-amount">Â¥{{item.value}}</text>
      </view>
    </view>
  </view>

  <!-- æ”¶æ”¯è¶‹åŠ¿å›¾ -->
  <view class="trend-section">
    <view class="section-header">
      <text class="section-title">æ”¶æ”¯è¶‹åŠ¿</text>
      <view class="trend-toggle">
        <text 
          class="toggle-item {{trendType === 'daily' ? 'active' : ''}}" 
          data-type="daily"
          bindtap="onTrendTypeChange"
        >æ—¥åº¦</text>
        <text 
          class="toggle-item {{trendType === 'monthly' ? 'active' : ''}}" 
          data-type="monthly"
          bindtap="onTrendTypeChange"
        >æœˆåº¦</text>
      </view>
    </view>
    
    <view class="chart-container">
      <canvas class="bar-chart" type="2d" id="barChart" style="width: 100%; height: 400rpx;"></canvas>
    </view>
  </view>

  <!-- è¯¦ç»†æ•°æ® -->
  <view class="detail-section">
    <view class="section-header">
      <text class="section-title">è¯¦ç»†æ•°æ®</text>
      <button class="detail-btn" bindtap="onToggleDetail">
        {{showDetail ? 'æ”¶èµ·' : 'å±•å¼€'}}
      </button>
    </view>
    
    <view class="detail-content" wx:if="{{showDetail}}">
      <!-- æ”¶å…¥æ˜ç»† -->
      <view class="income-detail">
        <view class="detail-header">
          <text class="detail-title">æ”¶å…¥æ˜ç»†</text>
          <text class="detail-total">åˆè®¡: Â¥{{formattedTotalIncome}}</text>
        </view>
        <view class="detail-list">
          <view 
            class="detail-item" 
            wx:for="{{statistics.categoryExpense}}" 
            wx:key="category"
          >
            <text class="item-category">{{item.category}}</text>
            <text class="item-amount">Â¥{{item.amount}}</text>
            <text class="item-percent">{{item.percentage}}%</text>
          </view>
        </view>
      </view>
      
      <!-- æ”¯å‡ºæ˜ç»† -->
      <view class="expense-detail">
        <view class="detail-header">
          <text class="detail-title">æ”¯å‡ºæ˜ç»†</text>
          <text class="detail-total">åˆè®¡: Â¥{{formattedTotalExpense}}</text>
        </view>
        <view class="detail-list">
          <view 
            class="detail-item" 
            wx:for="{{statistics.categoryExpense}}" 
            wx:key="category"
          >
            <text class="item-category">{{item.category}}</text>
            <text class="item-amount">Â¥{{item.amount}}</text>
            <text class="item-percent">{{item.percentage}}%</text>
          </view>
        </view>
      </view>
    </view>
  </view>

  <!-- é¢„ç®—è¿›åº¦ -->
  <view class="budget-section">
    <view class="section-header">
      <text class="section-title">é¢„ç®—è¿›åº¦</text>
      <text class="budget-status {{budgetStatusClass}}">
        {{budgetStatusText}}
      </text>
    </view>
    
    <view class="budget-progress">
      <view class="progress-bar">
        <view 
          class="progress-fill" 
          style="width: {{budgetProgress || 0}}%"
        ></view>
      </view>
      <view class="progress-text">
        <text class="progress-value">{{budgetProgress || 0}}%</text>
        <text class="progress-desc">å·²ç”¨ Â¥{{formattedBudgetUsed}} / é¢„ç®— Â¥{{formattedBudgetTotal}}</text>
      </view>
    </view>
    
    <view class="category-budgets">
      <view 
        class="category-budget" 
        wx:for="{{categoryBudgets}}" 
        wx:key="category"
      >
        <text class="budget-category">{{item.category}}</text>
        <view class="budget-progress-mini">
          <view 
            class="progress-fill-mini" 
            style="width: {{item.progress}}%"
          ></view>
        </view>
        <text class="budget-text">Â¥{{item.used}}/Â¥{{item.total}}</text>
      </view>
    </view>
  </view>

  <!-- æ“ä½œæŒ‰é’® -->
  <view class="action-section">
    <button class="action-btn refresh-btn" bindtap="onRefreshData">
      <text class="btn-icon">ğŸ”„</text>
      åˆ·æ–°æ•°æ®
    </button>
    
    <button class="action-btn share-btn" bindtap="onShareReport">
      <text class="btn-icon">ğŸ“¤</text>
      åˆ†äº«æŠ¥å‘Š
    </button>
  </view>
</view>