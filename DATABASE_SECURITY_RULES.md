# 数据库安全规则配置指南

## 集合权限类型说明

### 1. records 集合（记账记录）
**权限类型：用户级权限**
- **规则说明**：每个用户只能访问自己的记账记录
- **安全规则**：
```json
{
  "read": "doc._openid == auth.openid",
  "write": "doc._openid == auth.openid"
}
```

### 2. budgets 集合（预算设置）
**权限类型：用户级权限**
- **规则说明**：每个用户只能管理自己的预算设置
- **安全规则**：
```json
{
  "read": "doc._openid == auth.openid",
  "write": "doc._openid == auth.openid"
}
```

### 3. questions 集合（游戏题库）
**权限类型：混合权限**
- **读取权限**：所有用户可读（共享题库）
- **写入权限**：仅创建者可写（用户自定义问题）
- **安全规则**：
```json
{
  "read": true,
  "write": "doc._openid == auth.openid"
}
```

## 完整安全规则配置

### 在云开发控制台设置的安全规则：

```javascript
// 数据库安全规则
{
  "records": {
    ".read": "doc._openid == auth.openid",
    ".write": "doc._openid == auth.openid"
  },
  "budgets": {
    ".read": "doc._openid == auth.openid", 
    ".write": "doc._openid == auth.openid"
  },
  "questions": {
    ".read": true,
    ".write": "doc._openid == auth.openid"
  }
}
```

## 权限设计原理

### 1. 用户数据隔离（records、budgets）
- **目的**：保护用户隐私，防止数据泄露
- **实现**：通过 `_openid` 字段进行数据隔离
- **效果**：用户A无法看到用户B的记账记录和预算设置

### 2. 共享题库设计（questions）
- **目的**：促进内容共享，丰富游戏体验
- **实现**：读取权限开放，写入权限限制
- **效果**：所有用户可以使用共享题库，但只能修改自己添加的问题

### 3. 安全考虑
- **数据安全**：防止越权访问用户敏感财务数据
- **内容安全**：用户自定义内容需要审核机制
- **性能优化**：通过权限限制减少不必要的数据查询

## 配置步骤

### 方法一：云开发控制台配置
1. 登录微信开发者工具
2. 进入云开发控制台 → 数据库
3. 选择对应集合 → 权限设置
4. 选择"自定义安全规则"
5. 粘贴上述规则代码

### 方法二：通过云函数初始化
云函数 `quickstartFunctions` 已包含 `createCollection` 功能，可以自动创建集合。但安全规则仍需在控制台手动设置。

## 测试建议

### 权限测试用例
1. **用户A** 创建记账记录 → 应成功
2. **用户B** 读取用户A的记录 → 应失败
3. **用户A** 修改自己的预算 → 应成功  
4. **所有用户** 读取题库 → 应成功
5. **用户B** 删除用户A的问题 → 应失败

### 安全验证
- 确保财务数据严格隔离
- 验证共享内容的读取权限
- 测试边界情况下的权限控制

## 注意事项

1. **生产环境**：建议先在小程序体验版测试权限规则
2. **数据备份**：修改安全规则前备份重要数据
3. **渐进式部署**：可以先设置较宽松的规则，逐步收紧
4. **监控日志**：关注权限拒绝的日志，及时调整规则

这些安全规则设计既保障了用户数据安全，又提供了良好的用户体验。