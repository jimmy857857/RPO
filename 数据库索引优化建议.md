# 微信小程序云开发数据库索引优化建议

## 问题发现
在预算功能代码中发现以下数据库查询语句：
```javascript
db.collection('budgets').where({
  year: 2025,
  month: 10,
  _openid: 'o40yI5ORddAMU9_zF6QVXRck9uw4'
}).get()
```

## 索引优化建议

### 1. budgets集合组合索引
**查询模式：** 按年份、月份、用户ID查询预算数据
**建议索引：**
```
组合索引: year(升序), month(升序), _openid(升序)
```

**创建索引命令：**
```javascript
// 在云开发控制台执行
db.collection('budgets').createIndex({
  year: 1,
  month: 1,
  _openid: 1
})
```

### 2. records集合索引建议
根据代码分析，records集合的查询模式：

**查询1：按日期范围查询支出记录**
```javascript
db.collection('records').where({
  type: 'expense',
  date: db.command.gte(startDate).and(db.command.lte(endDate))
})
```

**建议索引：**
```
组合索引: type(升序), date(升序)
```

**查询2：按用户和日期查询**
```javascript
db.collection('records').where({
  _openid: '用户ID',
  date: db.command.gte(startDate).and(db.command.lte(endDate))
})
```

**建议索引：**
```
组合索引: _openid(升序), date(升序)
```

### 3. records集合更多索引建议

根据云函数代码分析，records集合有以下查询模式：

**查询1：按日期范围查询（统计功能）**
```javascript
db.collection('records').where({
  date: db.command.gte(startDate).and(db.command.lte(endDate))
}).orderBy('date', 'desc')
```

**建议索引：**
```
组合索引: date(降序)
```

**查询2：按用户和日期范围查询（数据导出）**
```javascript
db.collection('records').where({
  _openid: openid,
  date: db.command.gte(startDate).and(db.command.lte(endDate))
})
```

**建议索引：**
```
组合索引: _openid(升序), date(升序)
```

**查询3：按用户和类型查询（收支统计）**
```javascript
db.collection('records').where({
  _openid: openid,
  type: 'expense'
})
```

**建议索引：**
```
组合索引: _openid(升序), type(升序)
```

### 4. 其他集合索引建议

**users集合：**
- 按_openid查询：`_openid(升序)`

**games集合：**
- 按用户和模板类型查询：`_openid(升序), type(升序)`

**questions集合：**
- 按用户和类型查询：`_openid(升序), type(升序)`

## 索引创建方法

### 方法1：云开发控制台
1. 登录微信开发者工具
2. 进入云开发控制台
3. 选择数据库 → 集合管理
4. 选择对应集合 → 索引管理
5. 创建组合索引

### 方法2：使用快速创建链接
```
cloud://createindex?env=cloudbase-6gf6lvflcaee2b8f&collection=budgets&from=console&s=[{"field":"year","type":1},{"field":"month","type":1},{"field":"_openid","type":1}]
```

## 性能提升预期

| 查询类型 | 无索引 | 有索引 | 提升效果 |
|---------|--------|--------|----------|
| 预算查询 | 全表扫描 | 索引扫描 | 10-100倍 |
| 记录查询 | 全表扫描 | 索引扫描 | 10-100倍 |
| 用户查询 | 全表扫描 | 索引扫描 | 10-100倍 |

## 注意事项

1. **索引维护成本：** 索引会占用存储空间，并影响写入性能
2. **查询优化：** 确保查询条件与索引顺序匹配
3. **监控指标：** 定期监控查询性能，调整索引策略

## 实施计划

### 高优先级索引（立即创建）
1. **budgets集合：** `year, month, _openid` 组合索引
2. **records集合：** `_openid, date` 组合索引（覆盖用户数据查询）
3. **records集合：** `date` 单字段索引（降序，用于统计查询）

### 中优先级索引（一周内创建）
4. **records集合：** `_openid, type` 组合索引（用于收支分类统计）
5. **games集合：** `_openid, type` 组合索引
6. **questions集合：** `_openid, type` 组合索引

### 低优先级索引（根据使用情况创建）
7. **records集合：** `category` 单字段索引（如果分类查询频繁）
8. **records集合：** `amount` 单字段索引（如果金额范围查询频繁）

## 索引创建示例代码

### 在云开发控制台执行

```javascript
// budgets集合索引
db.collection('budgets').createIndex({
  year: 1,
  month: 1,
  _openid: 1
}, {
  name: 'budgets_year_month_openid'
})

// records集合索引
db.collection('records').createIndex({
  _openid: 1,
  date: 1
}, {
  name: 'records_openid_date'
})

db.collection('records').createIndex({
  date: -1
}, {
  name: 'records_date_desc'
})

db.collection('records').createIndex({
  _openid: 1,
  type: 1
}, {
  name: 'records_openid_type'
})
```

## 监控指标

- **查询响应时间：** 确保关键查询在100ms以内
- **索引使用率：** 监控索引是否被实际使用
- **集合文档数量增长：** 定期清理过期数据
- **内存使用情况：** 避免索引占用过多内存
- **查询扫描文档数：** 理想情况下应小于1000文档

## 性能测试建议

1. **测试数据量：** 使用10万条记录测试查询性能
2. **并发测试：** 模拟10个并发用户同时查询
3. **压力测试：** 测试大数据量下的统计查询性能
4. **监控报警：** 设置查询超时和性能下降报警

通过合理的索引设计，可以显著提升小程序的数据查询性能，改善用户体验。